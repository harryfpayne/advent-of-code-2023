package main

import (
	"fmt"
	"math"
	"strings"
	"time"
)

func main() {
	s := time.Now()
	grid, start := Parse(PUZZLE)

	type QueueItem struct {
		position Position
		age      int
	}

	queue := []QueueItem{
		{start, 0},
	}
	// Stores if for a given age I have already processed a given position
	queueAgeProcessedMap := make(map[int]map[Position]struct{})

	part2Limit := 26501365

	part1AgeLimit := 64
	part2AgeLimit := grid.height*2 + (part2Limit % grid.height)

	for len(queue) > 0 {
		curr := queue[0]
		if curr.age > part1AgeLimit {
			fmt.Println("part 1", len(queueAgeProcessedMap[part1AgeLimit]))
			part1AgeLimit = math.MaxInt // don't print again
		}
		if curr.age > part2AgeLimit {
			break
		}
		queue = queue[1:]

		if _, ok := queueAgeProcessedMap[curr.age]; !ok {
			queueAgeProcessedMap[curr.age] = make(map[Position]struct{})
		} else {
			if _, ok := queueAgeProcessedMap[curr.age][curr.position]; ok {
				continue
			}
			queueAgeProcessedMap[curr.age][curr.position] = struct{}{}
		}

		for _, position := range curr.position.Adjacent() {
			position := position
			if grid.CanMove(position) {
				queue = append(queue, QueueItem{
					position,
					curr.age + 1,
				})
			}
		}
	}

	// https://en.wikipedia.org/wiki/Newton_polynomial
	// Don't full understand this but saw it being used on reddit
	// Assume it's just a simplification for solving a quadratic equation given some points
	remainder := part2Limit % grid.height
	x1 := grid.height*0 + remainder
	x2 := grid.height*1 + remainder
	x3 := grid.height*2 + remainder

	y1 := len(queueAgeProcessedMap[x1]) + 1
	y2 := len(queueAgeProcessedMap[x2]) + 1
	y3 := len(queueAgeProcessedMap[x3]) + 1

	b0 := y1
	b1 := y2 - y1
	b2 := y3 - y2
	x := part2Limit / grid.height

	part2 := b0 + (b1 * x) + (x*(x-1)/2)*(b2-b1)

	fmt.Println("part 2", part2)
	fmt.Println("time", time.Since(s))
}

func Parse(str string) (Grid, Position) {
	str = strings.TrimSpace(str)
	var start Position
	var grid Grid
	for y, line := range strings.Split(str, "\n") {
		var row []bool
		for x, c := range line {
			row = append(row, c == '#')

			if c == 'S' {
				start = NewPosition(y, x)
			}
		}
		grid.g = append(grid.g, row)
	}

	grid.height = len(grid.g)
	grid.width = len(grid.g[0])
	return grid, start
}

const TEST = `
...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........`

const PUZZLE = `
...................................................................................................................................
.....................#..#.#.#..##..........#.#..#...#.......#...............##..#.....#.......#......#.#..........#..#.......##.#..
....##........#..#.......#......#.....#..............#...##.............#..............#...........#.......#.#....#..#....#..#.##..
......#..........#..#.#......##................#.#.......#..................###.....##.......#.....#..#.#..........#.......##.#..#.
.#....#.....#......##.........#..........#..##.....#.........................#.....##.#...#....###..##.#..........#.#..#.##........
....#..............##..#.......#..............#.....#.......................#.#..##...#.####........#.....#.#.....#...#.....#...#..
........#...#.#....#........##.........#............##..........#......................#...#.....#...#...#....#....#..#..#..#......
..#..#..#..#.....##.....#.....#..#.#.....#.#.#..#.............#.#.#..............#..#...........#..##..#.....#....#................
.......................#.#..#.#.#....#...##.......#..#........#...#................#.###....###..............##....##...#..........
...##.....#..............#.#...........#.........#.#.........#.....#................#.....#..#.....#................#....#.......#.
...#..........#.........#...........#....#.......#...........#.......................#.........#...........#........##.............
...........................#..#.##.....#.#......#.................#....#........#.###.......##.....#.#..#...#..##.#...#.#....#.#...
......#..#.#....#.##.#...#..#..#.#.............#.....................#...............#.....#.#...........#......#..................
...#..#..........#.......#..#.....................................................#......##...#..#.#........#.##.#..#.##...........
...#.#....###.#..............#.#.##.......................#............#...#........#.....#...##...#........#.#...#..............#.
...#............#....#......#.....#....#................#....#.#...#.#....#.........#........#.....#.....#.#..#..#.#.........#.....
.#..#.......#......#.#..#...#.#........#...............##............#......##.......#...#.#.#..#.#............#....#.......#..#...
.....##..#..#.............#.........#...#.#..........#......#........#.#..##............................##.....#..#....#..#......#.
.#.....#...##........#.........#..........#..........#..#...#...#.#........#............#.........#......#....#....................
..#........#.....#..#...#.#..##.....#..#...........##.....#..#..#.##..#..#......................#.#..#....#...#..##........#.##.##.
...............#..##............##.................##.........###......#..#.#..............###..........##..##..#........#.........
.......#.....#.............#....................#.......##.............##...#...........................#..#......##.##..#....#....
.###.....#......###.............#......#................#..#.#..#......#..#............................#.##....#.....#....#....#.#.
..##.#.........#........#.....#.#....#........##........##..........#..#...#..#....#..........##.........#..........#...##.........
..#.#.##.#...#....#..#.#.#......#...............#.#.#.#...#....#..#..##..#..#..#..#.#..............#.##.............#.#...#...##...
..#.#..#...........#......#.........................#....##..#..........................................#.................#........
.........#..#..................####............#.#..................#........##..................##.#..#..##.#..#.#.....#...#.#....
............#.##......#.......#...#.......#.....#........#...#..#...#.#...........#...#.#..........#..................#...#.#.#....
....#.........#...#.##....#.#...#..........#.........#..#......#...#...............#...#...............................#...#.......
.#....#.....#.........#..............................#....##.#.....#........#...#.......#...............#......#.....#....##.###...
................#............#.#.............#...........#..#.....#.##.....#.#.........#..............#..#....#....................
....#..................##................#......#............#.......#...............................##.#......#...##...........#..
...#..#..#.........##.#..............#.........##.#......#...........#.....#....#....#......#..............#......#..#........#.#..
.......#...#...#..#.....#...#...........#...........#......#...#.....#....#.....#..........#...............#.#.....#...#.....##....
....#....#........#..#...................#...#.###...........#.##.#......#....#.#..##...#...##.............#......#..#..#.......#..
....#.#....#......##..................#...................#.##.#.........................#................#......#.#.#....#........
.#......#..###...........#.............#........#......#.....#....#........#..................#.##........#...#....##...#..#.......
...................................#.........#................#..........#.......##..#..##...#...#.........#......##........#.#....
...#..#.........#............................#....#.....#....##..............#.........#...................#..#...#...#.....#..#.#.
...##..........#................###........##...#.....#...###.......#....#.........#.........#...#....................#......##....
.#.......####..#...#...........#..##..#..#.......#....##..#...##...#...#...#......#...#...#...#..#...#.........#.#..###...#...####.
.###........................#...............#..........#..#.#..#.......##..#.#.#.#.#....#..........#......................#.#......
......#...#....................#...##.....#..#........#................##..#....#.........#...#.......................#....##......
...#........#.................#...........#.#.....#....#...........#....#.......#....#..#.#.#.....#.............#.#.....#.....#.#..
.......##...##...#...........#.#.......#........#......##............#.......#....#.............#.#.#......................#.......
..####.....##................#.#.##............#.....#..........#........#....#..#.........#......#...#..##.........#...........#..
.#.#.#........#.........#.............#..............#...#....#.#....#..#....#..#....#.#.#.#..#..##......###..........##..#........
....#...#...#.#........##..#............#........##..#.............#..#....#..####..#..........#....#..............................
.....#......#................#...#..#...........#...##......#..............###........#....#.....#..........#......................
...#.................#.....##....#......#........#.#....#.........#..#.....#...................#.........#......................#..
....##..#.#.............#....#....#.......#..#......#..............#..............#......#..#.............#...#...........#...#....
..................#..........#.......##...##.#..#...#...........#....#.#......#.......###...#.##..........#...................#.#..
.................#...#....###.#..#...#.............#..#.#.............#...........#.#......##..#.#...##..##.#.#...........#.#......
....##..................#......#.#..##..#......#...............#.......#....#.........##...###..#..#..#......#..#.............#....
.....##.............##..........#................#........#...#.#..#.#...#..#..#....#.#............#...#..#.................#......
...............#..##.#.#...........##.#..........#.#.....##.##..#.......#.#...........##.......#.##.#.#....#.....##................
..#............#.........#.....#.#..................#..........#....#.......###...#.#...............#..##.....##.#.................
...............#..##..#.......#..#.......#..#.#.........#..#..........#..#..##..........#........................##...........##...
...........#.#.........#.#...........#.....#...................#...##.###...#.......#...#...#...##.....#....#...#.#................
............#....##......................#...#...........#......#..#......##.......#...........#....#.#..........#.....##.......##.
.#.......##........#............#...................#.#....#.#.......#...#........#....#..#..#...#....#............#...#...........
...................##..##......#.................#.#...........#.....#.#........#....#......#.................#..##....#...........
...........#......#.#.........#..#..#.......#.......##....................#.......##...##....#....#.....#..........................
.........#.#.#...#....##..#....##....##...........#....#...#..............#...#..###.#..#.................#..#...#.......##........
.............###...#.............#.....................................#...#......#......#............#.#.......#............#.....
.................................................................S.................................................................
.....#.#........#.............##.##.......#..#..##.....#............#....#..#.#.#.......#.#.................#..........#.....#.....
.........##.#............#..#........#.............#..#..#..#.##..#..#..........#..................#........#......#........#......
.......#..#..................#....#...#...#............##......#....#...#..............#..#...#........#....##...........#.........
.........##.....###............#..........##..##.........#.....##.........................#..............#.........##.#............
.............###.#....####...#..#....#......#.#..#.#.#.#......#.........#................#........#...#.#..........#..#............
.............#.#..#....#...............#.....#.#....#..#.....#.........#...#......#......#.#........#.##.#...#.....................
...........#....#.#........##....#...#.......#..........##..........#............#....#......#.#..........#.#..................#...
..............###......##....#.#......#..#....#...........#........#.#...#.....#.......#..#..#........#.........#....#.............
.#............#..#....##.#.....#..#..#.##....##.#....##.............#....###.....#......#.#...................#.##.................
...####.......................#.##.#...#.#......#..##.#.....#.......#....#....#...#.........#....#.#...........#...................
..#...##.......#...#.......##.#..#.....#.........#......#.#...#...........#..........#..........##.#......##.#...................#.
.#.#............#..#..#..#.#....#.....................#...........#.###.#........#...#...........#.........................#.......
..#...............#.#.##........#.#..#.##.#.#....##.##..#....#.....#................#.....#..#....#.........#...#.............##.#.
........#.#.......#...#......#........##.#.#.....##......#...............#.#...#..........................#..............#...#.....
...........#........#.......#......#..#..#....#.#.....#..##..#.#......#............#..........................#.................#..
.##.#....#............#........#......###...##....#####.#..#...........#...........#...........#......#..#....#............#.#..#..
......................#...........#....#.......#.#................#.#.#.........#.#.....#....................#........#..#.#..#.#..
.##........#...........#....#.........#..####..#............#.#.#...#.#..#.......#.....#..#.................#..........#....#..###.
....#.##.#..............#.#.........##......#........##............#.........##...#....#.#.......#.........................#....#..
......#.....##...............#............#..##........#...........#.##....................#........##..#.............#......#...#.
............................#..............#...#.......##....#....#..........##....#...#....#..##..#.#.............##...##...#.....
.#....#.....#....#...............#......#..#.#.#....#..#.##..............#.#.......#...............##...........#...........#...#..
.#...............#..........##....#..........#.....#.#...#..#.###.#...##........#......#.##.......#............#...#.#.#..#........
.......###...#................#.#......##.........#...##..##....#...#....###..........##.#.##.....................#.#...........#..
..##...#..##.#..#....#..........#.................#...#.........#.##.......#...##......#.#..#.....#..............#...#.............
.#.#....#.....#....#..................#.#...........#.............#..#......#...#........#..##..#.........................#.....#..
........#..##....#.................#......#.#...#..#......#.#............................#..#....#................#.........#....#.
.#......#...#......#.#..#.......#.#.....#..#...#......#.#..#.#.....#.#.................#...#..#.....................#....#.........
......#....#........#.###............##....#....##..#..............##..##.............#.........#...........#.#..#....#.#...#.#....
..#........#...................................#..###........#.#....#.#.#......#.#.............................#..##..#.......#....
.......#.#.#...#..........#........#.......#..##.......###.#..##....#............#.#...#...#............#...#................#..#..
....#...........#.#..#....###.........#...#.......#...#...................#....#.#.#..###....#...........................#.#.#.#...
....#....##.##.#.#.....#...#...................#.#.............#.............#...#..#.....#............#.......................#...
.........#..#..#....#....#................#..........#..................................#............#..##..........#.#......#.....
....#.#.#...#......##.....#...............##..........#.......##...#...#.##.....##.....#..#............##..............#....#.#....
..#......#.#......##........#...........#.#.#..#.........#.#..#.........#...#..........#..............##..#...#....#......#..#.....
.###..........#.#.....#..#.......#............#..#..............#...#..##.#.......#...............#.......#.................###..#.
.#......#..#.##......##.#..#.#.............#..#..#...###...#...#...#...........#....#.................##....#...........#..###.....
.#.........#...........#........#.#........#.#.#....#........#.....###....#.#..#.##.................##...#.........#..#......#.....
..#.#.........#........#.#.#..#.#...............##.#............#.....#.#............#.........#.#.............#.#.#.#...........#.
.....#.#................#.....#.#..#..................................#.#.#..#..#..#....................#.....#........#...........
.....#.#.........#.......#...#..#......................##.........#.#.##....##.....#........#...##.#..#..#...#.#....#..........###.
...#...........#.......#.#....#.......#...........#.....#....#..#..#....#..#..................#.#.........#.###...#....#....##.#...
....##....#.#......##....#...#....#..#................#..#..#...#.#....#.............................#.........#........#.#..##..#.
.#................#......#....##.#..###..#.......#...#.........##.#...##......#.#........#.#.......#......#........#.#...........#.
....#...........###.................#....##.......#..#.....#...#....#.........#................#..#....#...#...#....#...#.....#..#.
...#....#..#.........##.#.....#......##.............##............#..#........#.............##.##....#.....#.....#...#.....#.......
...#.#...#.#.#..#..............#..##..#.....#.......#..........#.....#.#..............................#............................
...#.....#.......#..#.......#....##.##..................#.##.............#.......................##..#.....#...#........#......#.#.
.....##.....#...........##.#.##.....#..###..................###......#..#..............#.#.#...#......#...###..........#.#..#..#.#.
...#.......#.......#.....##.................................#........##.#.............#...#............#.....##....#.....##...#....
.#.##............#.#..............#.....#...#..#...................#.#..............#....#....#.#.#.....##..#.#...#...#.#....##.##.
...........#....#....#.....##..........#.#.....##............#........#..#............#....##..#.#...#...##............##...#......
..........#.....##...............##......#......###..........##........#....................##......#...#........#...............#.
..#.......#.....#....#..............#.....#...#...............#.................##....#........#......##.#..........#.##....#..#.#.
...#..##..#.........#......#......#..##.#.........#...................#.......#............#........#......#.......#........#......
..................#.#.#.#...#.......#..##.#..#.#................#.#..............#.#...................#...#...#........#........#.
....#.#.#......#.....#...#.........#..#....#..#.#...#...............#.......#...#.............#.#.#.#.....#......#...#.#..#....##..
.....##.......#...#...........#.#.#.#....#.##...##.....#...................#...........#....#.#..#...#......##...........#..#...#..
.............#.#........#........#...##......#.....#.#.......................###..#.........##...........#.....##..##.....#.###....
......###..#.........#.#......#.........#.....#....#..#.#.................#.......#.........#....#.......#...###...#.............#.
..........##....#.#....#...#.......#.#....#.#...#.......#...............#.#..#............#..#...#.#....#..........#..#......#...#.
.#.......##..#.##....#.........#.....#.#.........##.................................#.....#....#.#.#..##.#....#..........#.#...#...
...........#.......#.#.#.#........#..........#.#..#.#..##.................#..#.................#.#....#...#......#.............#...
...................................................................................................................................`
