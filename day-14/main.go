package main

import (
	"strings"
)

type Grid [][]int32

func (g Grid) Cycle() Grid {
	for i := 0; i < 4; i++ {
		g = g.Tilt()
		g = g.Rotate()
	}

	return g
}

func (g Grid) Tilt() Grid {
	nextGrid := make(Grid, len(g))

	for y, row := range g {
		nextGrid[y] = make([]int32, len(row))
		for x, point := range row {
			if point != 'O' {
				nextGrid[y][x] = point
				continue
			}

			lastValidY := y
			for i := y - 1; i >= 0; i-- {
				if nextGrid[i][x] == '.' {
					lastValidY = i
				} else {
					break
				}
			}

			nextGrid[y][x] = '.'
			nextGrid[lastValidY][x] = 'O'
		}
	}

	return nextGrid
}

func (g Grid) Rotate() Grid {
	w := len(g)
	h := len(g[0])

	next := make(Grid, h)
	for y := 0; y < h; y++ {
		next[y] = make([]int32, w)
		for x := 0; x < w; x++ {
			next[y][x] = g[w-1-x][y]
		}
	}
	return next
}

func (g Grid) Score() int {
	score := 0
	for y, line := range g {
		for _, point := range line {
			if point == 'O' {
				score += len(g) - y
			}
		}
	}
	return score
}

func (g Grid) String() string {
	s := ""
	for _, line := range g {
		r := ""
		for _, point := range line {
			r += string(point)
		}
		s += r + "\n"
	}
	return s
}

func Parse(str string) Grid {
	str = strings.TrimSpace(str)
	var grid Grid
	for _, row := range strings.Split(str, "\n") {
		var line []int32
		for _, point := range row {
			line = append(line, point)
		}
		grid = append(grid, line)
	}
	return grid
}

const CYCLES = 1000000000

func main() {
	grid := Parse(TEST)
	tempGrid := grid

	history := make(map[string]int)

	loopStart := -1
	loopEnd := -1
	for i := 0; i < CYCLES; i++ {
		history[tempGrid.String()] = i
		tempGrid = tempGrid.Cycle()

		if val, ok := history[tempGrid.String()]; ok {
			loopStart = val
			loopEnd = i
			break
		}
	}

	loopLength := loopEnd - loopStart + 1
	effectiveCycles := (CYCLES - loopStart) % loopLength

	println(loopStart, loopEnd, effectiveCycles)

	for i := 0; i < loopStart+effectiveCycles; i++ { // Being a bit lazy, could use history to figure this out
		grid = grid.Cycle()
	}

	println(grid.Score())
}

/*
		69
	65
	64
	65
	63
	68
	69
		69
	65
	64
	65
	63
	68
	69
		69
	65
	64

	20 runs
	starts loop after 3 so looping for 20-3 = 17
	I'm going to do 17/6 cycles = 2.83

*/

const TEST = `
O....#....
O.OO#....#
.....##...
OO.#O....O
.O.....O#.
O.#..O.#.#
..O..#O..O
.......O..
#....###..
#OO..#....`

const PUZZLE = `
.O..........O.....O.#................#..O#.#......O...O.O...#....#...O.#...#O.O....#.#.........O....
...##OO.#O#......#.#..OO.O....###..#..O..#.O.OO...O.........O......O.O##.O..O.O..#O.#..O...#.OOO.O.O
#.O..OO.O..O.#.#..#.O.O..#..O...........O.OOOO...#..O.......O...O#......O.O..##O...O........#.......
...O...#..O.OO##.O#..O.#O..#....O....#...O.......O.O....#..##.....O.##.#.OOO.......OO......O....O.O.
....O...#..###..O.....O.#O.###..#O..O.....O.#.##OO..OO.O#.OO.#.....O....#.#O##.O.O.O...#O..O.#O.OOOO
#O.........OO....#.....O#..#.##........O..O#........#........O#O.O.O..#..OO.#O.#......O.#O..........
..OOO.O.#.#.O.#...O.#...O..O.O...#O.#O#O.#......OOO.O.#.....OOO.###.....OO#.#OO...##.....#O#....#...
.O...O#.....O..O...#.#.....O.O......#.....O....#.#OOO..#O........O.O...O..O##.O.....#..#.O..#O.#....
#.OO..#.O.......O.O.O##.O.O...................##.......#.........OO#.O....##..O.O..O.#.....O#..#.#..
#OOO..OOO.OO.#....#.O.....##.....O..#.OO#O.#..#..O..#..O.O...O....#..#...O.####..#O#.O....#.O.O.#...
OO..O.#O..O.O#O..#......O.#O...#....O........O....#..O.#O....#....O..#....O..OO##O#......#O.O.O..#O#
..O..##.......O.....##....O#..........#.#.O.##.......#.OO.#.#..O.#...O.....#OO.....O.O.O#........O.O
#..O....#.#..#O...#...#.....OO#..#.#.O..OO....#.#.O...O...O....O..#.#..O.#O.....O..##.O.O..O....#.##
O##.......##.OO..O.#.O..O.O#......O..OOO.....O...OO...O...#.O.O#..O..O.##O.#.....O..O.#O.#...O..O.OO
#O..O....OO.#..#.O...O.O.....O##......O.......O...#.#.....#..O........O.O...O....#O#..O.....#.O....O
O.......#...O...O.O...O....O.......O..#.#.O.##.......O#..O#....O###.O....#...OO...#.#......#........
....O.#.O##...#O..#OO.........O...O#O..O.....#..#...#........#....#..O.##......#.....O.O..OOOO..#...
....#....O#..#..O..........O....OO...O....O.....O.O#..OOO..O.O#..#...O#..#OO.O.O.O.O##.#...##....#..
.#..OO..OO.O#......#OO.O.O.#..O...##.#.....O......#....#..O#OO.#.....#..OO.O#O...#....#...O###O..OO#
#OO..#.O.O##.O......O..O......O.O.....O..O...#.O..O#..OOO.#O#O.#.#.#...##.#.O.O.......O....#..O..#O.
#.#...#....#.#..#.O.####.O...#O#.#....#O..........O.OO...#...........#.#.#..OO.#O..#..#O.O.O..#.O...
.O.##..#...OOO#O#..##.#O....O..#.O.#.#.OO.#..#...O.##...#......O#O#OOO.OO.#...O.O.......#O.O.OOOO##.
......O.........#..O...#...O.#O...#O.O#....#.O..O.OO...OO.O..O#.##...#...#......#.#.O...O#..##.OO.O.
O........O#.O#......O#...#..O#..OO....#.....OOO..O.O...#.O##..#...O..O.....................OOO......
OO...#O....OOO.O.O....#.O..O##OO..O.....#..O#.....#....O.....O..#...OO..#....OO#.#.O.....OOO#..O.OOO
.....#.##..O#O....O#...#.......##.#..O..............#..#...O.OO......#.......O#....#..O.#..#.O..#..#
.#.O.....O##O.#.#.#O.#.....#.......O...O.......#O.O.....O#O#O..#O..#O......OO...O#.O..O....##..O....
.......#.O.O#O#..##..#.OOOO.OO.##.#OO.#O#..O...O..OO.O.#.O#..O#O#O.O....#O.......OO..O...#...O.#....
#O.#...OO#.OO......O.O.O....#O....#O#O....O#..#O#.#....O#.##.#..O.......OO..O..O#OO#O....O#....##..#
..O.OO.O......O.OO....O#...O#O#.O##.....#OO...O....O.##..##..O.O.#..O##O.#O##.#.OOO.#.###..#OO...#O.
O....O..OO#O#...##.....OO....#..O...O.##.......O..#..##OO......#..O.....#..O.#...#.#..O..##O.......O
##.#..#..#..O.....O.#.##.......#.##........#....#.....O.....O.O#O..O.#O.#..#.#O.....O..O..#.O....OOO
.O.#O.#...O..#.......#..#O..#.O.OO...O..O...O.O..O...#..##OO..#......###O#.O..O..#.##........#....#O
..O....##...O#OOO.#O...#..O.O.#.O....##..#.#.O.OO..O#OO....O..OO.OO#......O.O........O.#O.....O#.O..
.OO#...#.OO.OO#.#...OO#.OOOO.O..O.#.OOO....#.OO...O.##..OO#OO.......#O.....O..##....O#.#.OO...O...#.
..#O.OO.O.#O.#...#.....O.#.#..##..O..##...OO#....#.#....O....##..O.........#...OOO..O..#O.....#...#.
#.O.....#..O...OO#....OO....##.....#.........O.O#.O.##.#OO..#.....#O..O............#.....#.......OO.
O..O.#.....O#.O..#O.........##O##..#........#..OO.....#.#...O....O..#.O......#O....OO.........#..OOO
O....#...O...#..........O..O#OO..#O..OO.#OOO....#..####OO#........#O...##.O...#.......OO.O#.....#..#
.#............#.#OOO..O##O...OO..O.#.O...O#O..#.##O..OO.#.O..OOO...#O.#.#O.....#..O...###O..#..#....
.....O.OOOOO..#.#OO...O.O.......#OO...#....OOO#......O...O.....O.#.........OOOO.......O......#.OO...
...#..O...O..O.#O.#O....##OO.O...O....O#....O...O....O#.O..#OO#.......#.O.............#.#O..........
..#.###...O#..O.#.O..#OO.O.OO...#.......O..#...OOO#O.....OO.###...O.#O.OO.O..O#O....O#.#...#...O..O.
..O.#...#...O#.O..#....#.O..O...#O....O.O..#..OO.........O#O.O.#..#O.#..O.O##..O..O......O#...O..#.#
O.O..O..O##.#O##O.#.O..OOO.......#..OO.O.##.#O.OOO.....O.O.O....O..#OO..O.....#O.....#....O..O..O#.O
.#...O.O..O....O...#O#.#O.##...#...#..O.OO#.....#O.O#....O#.##.O.O.O..#OO####......O#O....O......O#O
##.O..#...O....#....#.##.O.........O.##.O..#...#O..#.....O...#.O#........#.O#..OO...#.#OO...#....#..
.O...#O.O...O..#O.O#OO.#.....O.....##O..#.#..OO.O#.##.#.###O...OO....O....#.O.#...O...O....O.#..#..#
.O#....O.#......O...##.O...O.#.O#OO.....O#O.#.O..O.#O..#..#.....O..O.#.O..O..#....O..O#OO...##O.O...
.O.....#O#.......##O.......#O.O........OOO.......#.O#..#.......O....##....#.#O.......O.....O#....#OO
..#.#.OO.#.O.....O#.....#..O...OO.....OO.......O.O##..#.........#........O.O#O.....##...##..........
#O...............O.O.#.....O#O.....O..#.O....OO#O.O...##.....#.O#....O#..OOO.O.#.OO.#..#O#.O.####.#.
O#O.#.O#O...O.....#.O........#..O.....#..O.O..#.#.O.O#....O........O.O...O....O#...#OO#..O.###.O#.O.
..OO......#......#..O...O#O#..#O.#.#.#......#.....#.#..#...O.....#.O#O.OO...#O...#..#..OO.#...O.O#..
..#....O.............O#.#O.....##......O#O.O#.#O##..OO..##O.#O......O#O.O.#O#.#.#.#.#..#....OO.....O
...........#..O.O#.......O...#..O.O#..O.#....#...O...O.#.OO.....#....#..#...#..O...O.#......O#O.O.#.
.O#..O..O#..O.....O.#..#.#...O...O..O.OO.#...O.O......O.......OOO..#.#O..#....O..#O#...#.OO.O...#OO.
O.OO..O.....#.OOO...........O..#...........O........OO.#...O..#.O..O..O....#..##....O#.OO.OOO..##O##
..OOO.#...O#O###.OO...O..#.#.OO..O....O...#..#.#.#...O...##..O..OO##..OO...#....#...#.O.O.O..#......
..O..O.##O#.O..##.O..OO..O....#.#.O..#OO...O..O#.#.........O.......O#.OO........##....O..O#...#...#.
..#...O#O....OO.#...O#......#.O.O#O...#.O.#O.......O....#..O.#.....#...OO.O.#O..#....O..#..O.O#.#..O
.O.......#.OO....O.OO..##.#O#.O.O.#OOO.##.O.O...#.O....O#O#O..#..O.O......O#..O...#....#...#.#.O#...
....O.....O..O...O.#OOO.OO...O...O.O.#.....O#......OOO.OOO.#..##..#..OO............O.O.....O...O....
O#O..O.OOO......O...O...OO.O.....O#.O..#...O##.OOO.#...O.#.O#O....#O.#..#....O.O#....O.O...O.O.O...O
....#.O#.....O.#.#O.........#...#O...O.O#OO...#.......#O...#...........O..O.....O...O#.#O...#..O..O.
.#....#.......#..O#O..O.......O#O....O.O..##.O..O....O#..O.O..O....O#..OOO.O..O.#.#....##.##O.O.O.O.
...O##.OO........OO#.O..O....O.#.O............#....#O#.O#...#..O#####..##.......#.......#...##.O....
#..O...#...O....O.O.##O.#O..O#...O...#..#O.#.O.O.O###...O.....O......#....O#...OO.O...#...#.O...OO..
#.....#.OOO..O....#O##...OO....O.#OO.O..#.#..OO.#.O..##O.###O..##..O...##.....#.OO..O.#.OO.O..#...O.
.#O#...O...OO.O.....#........O##.#.O#O...O..#OO.#.....O....O.O.O..O.#..O..O..O..#..#...#.#OO...O..#O
..#...#......O....OO.O.#..O....O..O...#.......##O#.#OOO..#.##...O..O...O..#......#.O....OO..O.O..O#O
..##.O.........O........O#.#..O.O...O.O##O.....O.OO......O#.....#O.....##OO#O#..O#.O......O....#...O
.O.#...#..........#..##...#.O...#..........#O.#.#....#..O..##..#.O..O.......O......O.#O.#O...#...#..
..O.OO.....O.O.O.OO..O.O#O.OO.........OOO.O..O..OOOO...O....O#...#..O.#.O.O..O..OO...O..OO.O.##..OO#
..O#..#..O..#..OOOO......##.#..#....#...OO.O.O#.#.....O...#OO....O..##..#.#...##.#...O.##O...O......
.....O.O..O....#.O#....#..O.......#......#..##...#...#.....#O..O..OOO.....O.........OO.#O..O..O.#O.#
##.#OO......##..O#..#.OOO..OO.#....OO.#.OO..#..#.......O#...OO.#.O........O.#.O...#O....#....O...O.O
OO.O...#..O..O.O#.#O..........#....O....O.#.....#.O......#....O...O#..OO.#...OO....OO.O...#...OO..##
..O...O...O##..O...O.....##..OO....OO..O.......O.O.#..#.O.O..O..OO#....O..#..#.O......#O#O.O#.O#OO..
...O.OO.....O....#..#....O...#..O.....#OO#O#.#.###...#.O.O.O#.#....#..O...O.....OO..#....OO#...#....
.O.OO....O#.....OO.O#O..#...#....#..O..O....#....O....O.O.#O.##....O........O#.O....O#.O.O#...#O#...
...O.#.#.....OO.OO#.O......#......##...#.#..#O.....#O...O#..#O#O..#..O.....OO##.......O.#.O#....O.#.
..#....O.....##.....O#.O...O.#..#......O....#......OO.O.#....#..............#.....O.......#O.....#.O
..O#...#.O..#.OO..#..O...OOOOOOO.OO#..O........#....O....OO.#OO.......#..O.O...OO.....O.OOOO#O...O..
.O#.#O.#O...#...O#..........O.....O.O.#.....#....O..OO.OOOO......#..O#..#..#....O....O.OO.#....#O.O#
..#OO....O#....O..#....#....O.#...OO#O....OO#.........O..O.O.....#OO....#O##..OOO.#..#O..O..O...O...
.O...#O#..O....OO...O.#...O....#....O...#....#O.#O.O.#O#.O.O#......O............#....#...O.O.#......
#OOO..##....#O.O..OO..O##.......O#.##O..#....#.##.#.#OO........#....#....O...#........O...O..O.O#...
...#.#..#...O...OO.O..#O...O.O......#...OO...OO.#O.....O..O##.##..O.....O......O.OO..#.O....O.#OOO.O
...O.....#........#O.#.OO.#.......O...O....O.#....#.#......O.O..#.#.O.......##......OO.O..O..#OO.O#.
##.O..O#..#...#.#O...O.......#O.OO.....OO...O.OO.....O.......O.....O#....O...O#.O...O..##....#O.O.#.
O.O.#OO.O.#.....#O.O..#O.O...##...#.O......OO.#...#..O.OO.O..........#..OO.....OO..O#.#...#.O..O#O..
.O.#O#O....O...##....O.O.##..........#O.#O#.#..O.#..#O....O..OO......O...#...##O.O.O#.####.OO.O#.O#.
.....OO.#.O..#O###OO#O.O.O.#.......#.#...#.#O....O.O..........#O....O..##.#.....OOO##..O.....#.....#
#....O..O.O.O...O#OO.O...O......O....O#..#....#.O..#..#.O..##O#..OO..O.#.O#..OO.....O.....OO#O....#O
.....OOO...#...#..#.#...O#.O..#.O#O.O##...O.....O...O.#.O..OO......O...O.........#O..#O.#O.....O...O
O........##..O..OO#....#.#O#.O.O..#..OO........OOO..O.OO.#..OO.#..O..##.O...OO.OO....O##.O......O.O.
#O.#.#.O#..O.O........#...O...O.#...##.#..O.#..#..O..#O..O.......O....O.O#O...........O#...#...O#...
...#O..#...#..O###....#O#..O..O...#OO...OO.OO#OO.#...O....O.........#..#O......#..#.......#O#O#..#O.
..O#.....#..##.O#.........#O...#.#.....O..#..#.#OO.#.O.....#O.....O.#.......O....#O..O#..O..O.O...OO`
